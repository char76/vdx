/*
 * All files in this project are distributed under the GNU General
 * Public License. This is Free Software.
 */
/****************************************************************
 *
 *  $RCSfile: GlobalResEditor.C,v $
 *  $Date: 1999/08/27 15:31:02 $
 *  $Revision: 1.1.1.1.2.1 $
 *
 *  Copyright 1997, Dirk Laessig
 *  ALL RIGHTS RESERVED
 *  See the file Copyright for more information
 *
 *  Dirk Laessig
 *  Goettingstr. 5
 *  38106 Braunschweig
 *  Germany
 ****************************************************************/
/*
 * $Log: GlobalResEditor.C,v $
 * Revision 1.1.1.1.2.1  1999/08/27 15:31:02  dirk
 * Transform the copyright to GPL
 *
 * Revision 1.1.1.1  1998/04/24 23:45:18  lazy
 * Imported to CVS
 *
 * Revision 1.2  1997/09/02  22:23:32  lazy
 * It works.
 *
 */

// ------------------------------ 
// GlobalResEditor.C                      
//
// This file was automaticly generated by
// View Designer/X v1.1.0
//
// User: lazy@apfel.goetting5
// Date: Sun Jun 29 11:28:44 1997
//
// ------------------------------

#include "GlobalResEditor.h"
#include "Lproject.h"
#include <lwid/Bubble.h>

RefArray<GlobalResEditor> GlobalResEditor::allViews;

// ------------------------------
// showView()
// ------------------------------
void
GlobalResEditor::showView(Lproject *model)
{
  ::GlobalResEditor *v;

  for(unsigned int i=0; i<allViews.getSize(); i++) {
    if(allViews[i]->model == model) {
      allViews[i]->open();
      return;
    }
  }
  v = new ::GlobalResEditor(model);
  v->open();
}

// ------------------------------
// GlobalResEditor()
// ------------------------------

GlobalResEditor::GlobalResEditor(Lproject *model)
:GlobalResEditor_base(NULL, NULL, 0) 
{
  XtVaCreateWidget("fontChooserBubble", 
		   xlBubbleWidgetClass, fontChooserButton, NULL);
  XtVaCreateWidget("colorSelectBubble", 
		   xlBubbleWidgetClass, colorSelectButton, NULL);
  XtVaCreateWidget("applyBubble", 
		   xlBubbleWidgetClass, applyButton, NULL);

  textView = new GlobalResTextView(model, text);

  LicView::quickHelpLabel = quickHelpLabel;
  this->model = model;
  XmTextSetString(text, model->getGlobalResources());
  allViews.add(this);
  setGeometryModel(app);
  setModel(model);
}

// ------------------------------
// ~GlobalResEditor()
// ------------------------------
GlobalResEditor::~GlobalResEditor()
{
  if(!textView.isNil())
    textView.Delete();
}

// ------------------------------
// do_apply()
// ------------------------------
void GlobalResEditor::do_apply(Widget, XtPointer)
{
  textView->apply();
}


// ------------------------------
// doExit()
// ------------------------------
void GlobalResEditor::doExit(Widget, XtPointer)
{
  close();
  delete this;
}


// ------------------------------
// cutText()
// ------------------------------
void GlobalResEditor::cutText(Widget, XtPointer)
{
  XmTextCut(text, CurrentTime);
}


// ------------------------------
// copyText()
// ------------------------------
void GlobalResEditor::copyText(Widget, XtPointer)
{
  XmTextCopy(text, CurrentTime);
}


// ------------------------------
// pasteText()
// ------------------------------
void GlobalResEditor::pasteText(Widget, XtPointer)
{
  XmTextPaste(text);
}


// ------------------------------
// do_onHelp()
// ------------------------------
void GlobalResEditor::do_onHelp(Widget, XtPointer)
{
  getHelp(HID_USING_HELP);
}


// ------------------------------
// do_onContext()
// ------------------------------
void GlobalResEditor::do_onContext(Widget, XtPointer)
{
  contextHelp();
}


// ------------------------------
// helpMe()
// ------------------------------
void GlobalResEditor::helpMe(Widget wg, XtPointer)
{
  printf("Callback GlobalResEditor::helpMe called by widget '%s'.\n",
         XtName(wg));
}


// ------------------------------
// importFile()
// ------------------------------
void GlobalResEditor::importFile(Widget wg, XtPointer)
{
  XmString xmstr;
  char *filename;

  XtVaGetValues(wg, 
		XmNtextString, &xmstr,
		NULL );
  XmStringGetLtoR( xmstr, XmSTRING_DEFAULT_CHARSET, &filename );
  
  if(filename) {
    FILE *fp;
    char *t;
    size_t size;
    
    fp = fopen(filename, "r");
    if( fp ) {
      fseek( fp, 0, SEEK_END );          // a kind of getting file size
      size = ftell(fp);
      rewind(fp);
      
      t = new char[size+1];                    // create buffer and read
      fread(t, sizeof(char), size, fp);
      t[size]=0;
      fclose(fp);
      
      XmTextInsert(text, XmTextGetCursorPosition(text), t);
      delete t;
    } else
      printf("Can't open file '%s' for reading.\n", filename);
  }
}


// ------------------------------
// do_fontChooser()
// ------------------------------
void GlobalResEditor::do_fontChooser(Widget, XtPointer)
{
  if(fontSelect.isNil())
    fontSelect = new FontSelect(textView);
  fontSelect->open();
}


// ------------------------------
// do_ColorSelect()
// ------------------------------
void GlobalResEditor::do_ColorSelect(Widget, XtPointer)
{
  if(colorSelect.isNil())
    colorSelect = new ColorSelect(textView);
  colorSelect->open();
}

// -------------------------------
// apply()
// -------------------------------
Boolean 
GlobalResEditor::GlobalResTextView::apply()
{
  char *str;

  str = XmTextGetString(text);
  lproject->setGlobalResources(str);
  XtFree(str);
  return TRUE;
}

// -------------------------------
// getText()
// -------------------------------
void 
GlobalResEditor::GlobalResTextView::getText(char *s, unsigned long &l)
{
  char *str;
  char *constString = "";
  unsigned int len;
  
  str = XmTextGetSelection(text);
  if(str == NULL)
    str = constString;
  
  len = strlen(str) + 1;
  if(s == NULL || l < len) {
    l = len;
  } else {
    strcpy(s, str);
  }
  if(str != constString)
    XtFree(str);
}

// -------------------------------
// setText()
// -------------------------------
void 
GlobalResEditor::GlobalResTextView::setText(char *str)
{
  XmTextPosition left;
  XmTextPosition right;
  
  if(XmTextGetSelectionPosition(text, &left, &right)) {
    XmTextReplace(text, left, right, str);
  } else {
    XmTextInsert(text, XmTextGetInsertionPosition(text), str);
  }
}
