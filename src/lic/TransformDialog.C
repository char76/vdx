/*
 * All files in this project are distributed under the GNU General
 * Public License. This is Free Software.
 */
/****************************************************************
 *
 *  $RCSfile: TransformDialog.C,v $
 *  $Date: 1999/08/27 15:32:05 $
 *  $Revision: 1.1.1.1.2.1 $
 *
 *  Copyright 1997, Dirk Laessig
 *  ALL RIGHTS RESERVED
 *  See the file Copyright for more information
 *
 *  Dirk Laessig
 *  Goettingstr. 5
 *  38106 Braunschweig
 *  Germany
 ****************************************************************/
/*
 * $Log: TransformDialog.C,v $
 * Revision 1.1.1.1.2.1  1999/08/27 15:32:05  dirk
 * Transform the copyright to GPL
 *
 * Revision 1.1.1.1  1998/04/24 23:45:18  lazy
 * Imported to CVS
 *
 * Revision 1.4  1998/03/30 19:08:45  lazy
 * *** empty log message ***
 *
 * Revision 1.3  1997/09/07  15:02:22  lazy
 * Fix asChildOk call
 * delete printfs
 *
 * Revision 1.2  1997/09/02  22:22:44  lazy
 * disable menu items depending on the parent
 * and children classes.
 *
 * Revision 1.1  1997/07/25  20:35:41  lazy
 * Initial revision
 *
 */

// ------------------------------ 
// TransformDialog.C                      
//
// This file was automaticly generated by
// View Designer/X v1.1.0
//
// User: lazy@apfel.goetting5
// Date: Fri Jul 18 18:23:25 1997
//
// ------------------------------

#include "TransformDialog.h"
#include "Lwidget.h"
#include "lic.h"
#include <Xm/PushB.h>
#include <lac/TArray.h>

RefArray<TransformDialog> TransformDialog::allViews;

// ------------------------------
// TransformDialog()
// ------------------------------

TransformDialog::TransformDialog(Lwidget *lwidget)
:TransformDialog_base(NULL,NULL,0)
{
  Widget w;
  Lwidget *parent;

  TSortArray<Lcreator> classes;

  this->model = lwidget;
  allViews.add(this);

  parent = lwidget->getParent();

  for(unsigned int i=0; i<Lcreator::getContainer().getSize(); i++) {
    classes.add(Lcreator::getContainer()[i]);
  }
  classes.sort();

  for(unsigned int i=0; i<classes.getSize(); i++) {
    w = XtVaCreateManagedWidget(classes[i]->getShortName(),
				xmPushButtonWidgetClass, pulldownMenu,
				XmNuserData,
				(Lcreator*)classes[i],
				NULL);
    if(parent && !parent->getClass()->asChildOk(classes[i])) {
      XtSetSensitive(w, FALSE);
    } else {
      for(unsigned int j=0; j<lwidget->getChildren().getSize(); j++)
	if(!classes[i]->asChildOk(lwidget->getChildren()[j]->getClass())) {
	  XtSetSensitive(w, FALSE);
	  break;
	}
    }
    if(lwidget->getClass() == classes[i])
      XtVaSetValues(widgetClassOptionMenu, XmNmenuHistory, w, NULL);
  }
  XtDestroyWidget(pushButton);

  setModel(lwidget);
}

// ------------------------------
// ~TransformDialog()
// ------------------------------
TransformDialog::~TransformDialog()
{
}

// ------------------------------
// do_cancel()
// ------------------------------
void TransformDialog::do_cancel(Widget, XtPointer)
{
  delete this;
}


// ------------------------------
// do_help()
// ------------------------------
void TransformDialog::do_help(Widget, XtPointer)
{
}


// ------------------------------
// do_ok()
// ------------------------------
void TransformDialog::do_ok(Widget, XtPointer)
{
  Widget button = NULL;
  Lcreator *newClass;
  Lwidget *parent;
  
  parent = model->getParent();

  if(parent == NULL) {
    printf("Changing the class of a toplevel is not supported\n");
    return;
  }

  XtVaGetValues(widgetClassOptionMenu, XmNmenuHistory, &button, NULL);
  if(button) {
    XtVaGetValues(button, XmNuserData, &newClass, NULL);
    if(newClass != model->getClass()) {
      YResult *dummy;
      dummy = (YResult*)malloc(sizeof(YResult));
      memset( dummy, 0, sizeof(YResult) );
      dummy->root_widget = model->createYWidget();
      strcpy(dummy->root_widget->widget_class, newClass->getName());

      delete model;

      Lwidget *copied = new Lwidget( dummy->root_widget );
      //      copied->getProperties()->fillWithDefaults(copied->getClass()->getDummy());
      parent->add(copied);

      parent->changed(CONTAINER_CHANGED);
      free_YResult(dummy);
      
    } else {
      delete this;
    }
  }
}


// ------------------------------
// showView()
// ------------------------------

void
TransformDialog::showView(Lwidget *lwidget)
{
  ::TransformDialog *view = NULL;
  for(unsigned int i=0; i<allViews.getSize(); i++) {
    if(allViews[i]->model == lwidget) {
      view = allViews[i];
      break;
    }
  }

  if(view == NULL) {
    view = new ::TransformDialog(lwidget);
  }
  view->open();
}


// ----------------------------
//      update()
// ----------------------------
void TransformDialog::update( unsigned long flags )
{
  if(flags & NAME_CHANGED) {
    char title[256];
    msgCat->getMsg(title, TRANSFORM_DIALOG_TITLE, 
		   model->getName(), 
		   model->getClass()->getName() );
    XtVaSetValues(popupShell, 
		  XmNtitle, title,
		  XmNiconName, title,
		  NULL );
  }
}



